{% extends "base.html" %}

{% block content %}
    <!-- Main Content -->
    <main class="container mx-auto my-8 px-4">
        <!-- Search Section -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
            <!-- Centered Title -->
            <h2 class="text-2xl font-bold text-center mb-4">Search Your Dream Package!</h2>
            
            <!-- Search Form -->
            <form method="get" action="" class="flex items-center justify-center space-x-4">
                <input type="text" name="search" placeholder="Search..." value="{{ search_term }}" class="w-2/3 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-md">
                    Search
                </button>
            </form>
        </div>

        <!-- Results and Infobox Layout -->
        {% if results %}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Results Table -->
            <div class="lg:col-span-2 overflow-x-auto">
                <table class="w-full table-auto bg-white shadow-md rounded-lg">
                    <thead class="bg-blue-600 text-white">
                        <tr>
                            <th class="p-4 text-left">Package ID</th>
                            <th class="p-4 text-left">Place 1</th>
                            <th class="p-4 text-left">Place 2</th>
                            <th class="p-4 text-left">Place 3</th>
                            <th class="p-4 text-left">Place 4</th>
                            <th class="p-4 text-left">Place 5</th>
                            <th class="p-4 text-left">Location</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in results %}
                        <tr class="odd:bg-gray-100 even:bg-gray-50 hover:bg-gray-200">
                            <td class="p-4">{{ result.package }}</td>
                            <td class="p-4 cursor-pointer text-blue-600 hover:underline" onclick="fetchPlaceInfo('{{ result.place1 }}', '{{ result.place1_iri }}', '{{ result.place1_code }}')">{{ result.place1 }}</td>
                            <td class="p-4 cursor-pointer text-blue-600 hover:underline" onclick="fetchPlaceInfo('{{ result.place2 }}', '{{ result.place2_iri }}', '{{ result.place2_code }}')">{{ result.place2 }}</td>
                            <td class="p-4 cursor-pointer text-blue-600 hover:underline" onclick="fetchPlaceInfo('{{ result.place3 }}', '{{ result.place3_iri }}', '{{ result.place3_code }}')">{{ result.place3 }}</td>
                            <td class="p-4 cursor-pointer text-blue-600 hover:underline" onclick="fetchPlaceInfo('{{ result.place4 }}', '{{ result.place4_iri }}', '{{ result.place4_code }}')">{{ result.place4 }}</td>
                            <td class="p-4 cursor-pointer text-blue-600 hover:underline" onclick="fetchPlaceInfo('{{ result.place5 }}', '{{ result.place5_iri }}', '{{ result.place5_code }}')">{{ result.place5 }}</td>
                            <td class="p-4 cursor-pointer text-blue-600 hover:underline">{{ result.location }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Infobox -->
            <div id="infobox" class="bg-white shadow-lg p-6 rounded-lg lg:col-span-1 max-h-96 overflow-y-auto">
                <h3 class="text-xl font-semibold mb-4 text-blue-600 hover:underline cursor-pointer" id="infobox-title" onclick="redirectToDestination()"></h3>
                <ul id="infobox-details" class="list-disc pl-4 text-gray-700"></ul>
            </div>
        </div>
        {% else %}
        <p class="text-center text-gray-600">No results found for "{{ search_term }}".</p>
        {% endif %}
    </main>

    <script>
        let currentPlaceCode = null;
    
        async function fetchPlaceInfo(placeName, placeIRI, placeCode) {
            currentPlaceCode = placeCode;
            
            try {
                const response = await fetch("{% url 'fetch_rdf_data' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                    body: new URLSearchParams({
                        "place_iri": placeIRI
                    })
                });
    
                const data = await response.json();
    
                if (response.ok) {
                    const description = data.description.length > 250 
                        ? data.description.substring(0, 250) + "..." 
                        : data.description;
                    document.getElementById('infobox-title').innerText = placeName;
                    document.getElementById('infobox-details').innerHTML = `
                        <li><strong>Description:</strong> ${description}</li>
                        <li><strong>Category:</strong> ${data.category}</li>
                        <li><strong>Rating:</strong> ${data.rating}</li>
                    `;
                } else {
                    document.getElementById('infobox-title').innerText = "Error";
                    document.getElementById('infobox-details').innerHTML = `<li>${data.error}</li>`;
                }
            } catch (error) {
                document.getElementById('infobox-title').innerText = "Error";
                document.getElementById('infobox-details').innerHTML = "<li>Unable to fetch place information.</li>";
                console.error("Error fetching place info:", error);
            }
        }

        function redirectToDestination() {
            if (currentPlaceCode) {
                const destinationUrl = "{% url 'destination_detail' 'PLACE_CODE' %}".replace("PLACE_CODE", currentPlaceCode);
                window.location.href = destinationUrl;
            }
        }
    </script>
    
{% endblock %}
